name: Deploy to GCP VM

on:
  push:
    tags:
      - 'v*' # Sadece v1.0, v2.1.4 gibi tag'ler pushlandığında çalışır

env:
  PROJECT_ID:  gen-lang-client-0290185580        # Kendi Proje ID'niz
  GAR_LOCATION: us-central1         # Artifact Registry bölgesi
  REPOSITORY: my-app-repo           # Artifact Registry depo adı
  IMAGE: my-server-image            # İmaj adı
  VM_NAME: my-gcp-instance          # VM adınız
  ZONE: us-central1-a               # VM'nin bulunduğu bölge

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. GCP Kimlik Doğrulaması
      - name: Google Auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # 2. gcloud CLI Kurulumu
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      # 3. Docker'ı Artifact Registry için Yetkilendirme
      - name: 'Docker Auth'
        run: |-
          gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev

      # 4. İmajı Build Etme ve Pushlama
      - name: Build and Push Container
        run: |-
          docker build -t "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE }}:${{ github.ref_name }}" .
          docker push "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE }}:${{ github.ref_name }}"

      # 5. GCP VM'yi Yeni İmajla Güncelleme
      - name: Update VM Instance
        run: |-
          gcloud compute instances update-container ${{ env.VM_NAME }} \
            --zone=${{ env.ZONE }} \
            --container-image="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE }}:${{ github.ref_name }}"